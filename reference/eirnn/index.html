
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fietelab.github.io/torch-biopl-dev/reference/eirnn/">
      
      
        <link rel="prev" href="../../examples/connectome_forward_neuron_types/">
      
      
        <link rel="next" href="../connectome/">
      
      
      <link rel="icon" href="../../images/biopl-logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Spatially embedded networks - torch-biopl</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRed+Hat+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Red Hat Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="mcgovern" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spatially-embedded-cortical-networks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="torch-biopl" class="md-header__button md-logo" aria-label="torch-biopl" data-md-component="logo">
      
  <img src="../../images/biopl-logo-light.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            torch-biopl
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spatially embedded networks
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/FieteLab/torch-biopl-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    FieteLab/torch-biopl-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="torch-biopl" class="md-nav__button md-logo" aria-label="torch-biopl" data-md-component="logo">
      
  <img src="../../images/biopl-logo-light.png" alt="logo">

    </a>
    torch-biopl
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/FieteLab/torch-biopl-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    FieteLab/torch-biopl-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick start guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Spatially embedded networks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Spatially embedded networks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/basic_spatial_example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic example
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/advance_configs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced configurability
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Connectome-constrained models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Connectome-constrained models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/connectome_forward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running forward dynamics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/connectome_backward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running reverse dynamics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/connectome_forward_neuron_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cell typing connectomes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Spatially embedded networks
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Spatially embedded networks
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;spatially_embedded
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" spatially_embedded">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.Conv2dRectify" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Conv2dRectify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedArea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedAreaConfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedRNN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../connectome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connectome-constrained models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sparse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sparse utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Misc utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;spatially_embedded
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" spatially_embedded">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.Conv2dRectify" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Conv2dRectify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedArea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedAreaConfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SpatiallyEmbeddedRNN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="spatially-embedded-cortical-networks">Spatially embedded cortical networks<a class="headerlink" href="#spatially-embedded-cortical-networks" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="src.bioplnn.models.spatially_embedded" class="doc doc-heading">
            <code>spatially_embedded</code>


<a href="#src.bioplnn.models.spatially_embedded" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="src.bioplnn.models.spatially_embedded.Conv2dRectify" class="doc doc-heading">
            <code>Conv2dRectify</code>


<a href="#src.bioplnn.models.spatially_embedded.Conv2dRectify" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Conv2d">Conv2d</span></code></p>


        <p>Applies a 2d convolution with nonnegative weights and biases.</p>







              <details class="quote">
                <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Conv2dRectify</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies a 2d convolution with nonnegative weights and biases.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass of the layer.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to `nn.Conv2d`.</span>
<span class="sd">            **kwargs: Keyword arguments passed to `nn.Conv2d`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The convolution output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.Conv2dRectify.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.Conv2dRectify.forward" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Forward pass of the layer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional arguments passed to <code>nn.Conv2d</code>.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments passed to <code>nn.Conv2d</code>.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The convolution output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass of the layer.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Positional arguments passed to `nn.Conv2d`.</span>
<span class="sd">        **kwargs: Keyword arguments passed to `nn.Conv2d`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The convolution output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea" class="doc doc-heading">
            <code>SpatiallyEmbeddedArea</code>


<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>A biologically-plausible, spatially embedded neural area.</p>
<p>This module imposes a series of biologically-inspired constraints on
artificial neural networks. At its core, it is a collection of 2D (hence
spatially embedded) convolutional layers organized into a 'circuit
motif'. Here, 'circuit motif' refers to the connectivity pattern between
the input, feedback, neuron types, and output within a distinct neural
area. For example, if we have two neuron types, an excitatory and an
inhibitory, then the circuit motif determines which neuron types receive
input, which neuron types receive feedback, which neuron types are connected
to which other neuron types, and which neuron types project to the output of
the area.</p>
<h5 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea--key-features">Key features:<a class="headerlink" href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea--key-features" title="Permanent link">&para;</a></h5>
<ul>
<li>Configurable neuron types (excitatory/inhibitory/hybrid)</li>
<li>Configurable spatial extents of lateral connections (same/half)</li>
<li>Convolutional connectivity between neuron populations</li>
<li>Recurrent dynamics with learnable time constants</li>
<li>Optional feedback connections</li>
<li>Customizable activation functions</li>
</ul>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.in_size">in_size</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial size of the input data
(height, width).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.in_channels">in_channels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of input channels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.out_channels">out_channels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of output channels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.feedback_channels">feedback_channels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of feedback channels (0 if none).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.use_feedback">use_feedback</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether this area receives feedback from another
area.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.in_class">in_class</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of input signal ("excitatory", "inhibitory", or
"hybrid").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.feedback_class">feedback_class</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of feedback signal ("excitatory", "inhibitory",
or "hybrid").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.out_nonlinearity">out_nonlinearity</span></code></td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity applied to the output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.num_neuron_types">num_neuron_types</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of neuron types in the area.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.num_neuron_subtypes">num_neuron_subtypes</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of subtypes for each neuron type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_type_class">neuron_type_class</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of each neuron type ("excitatory",
"inhibitory", or "hybrid").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_type_density">neuron_type_density</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial density of each neuron type
("same" or "half").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_type_nonlinearity">neuron_type_nonlinearity</span></code></td>
            <td>
                  <code><span title="torch.nn.ModuleList">ModuleList</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity for each neuron
type's activity.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_type_size">neuron_type_size</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial size of each neuron type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.num_rows_connectivity">num_rows_connectivity</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows in the connectivity matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.num_cols_connectivity">num_cols_connectivity</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of columns in the connectivity matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.inter_neuron_type_connectivity">inter_neuron_type_connectivity</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity matrix for the
circuit motif.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.inter_neuron_type_spatial_extents">inter_neuron_type_spatial_extents</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial extent for each
circuit motif connection.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.inter_neuron_type_num_subtype_groups">inter_neuron_type_num_subtype_groups</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of subtype groups
for each circuit motif connection.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.inter_neuron_type_nonlinearity">inter_neuron_type_nonlinearity</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity for each circuit
motif connection.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.inter_neuron_type_bias">inter_neuron_type_bias</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a bias term for each
circuit motif connection.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.tau_mode">tau_mode</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mode determining which parts of neuron activity share
a time constant.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.tau_init_fn">tau_init_fn</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization for the
membrane time constants.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.tau">tau</span></code></td>
            <td>
                  <code><span title="torch.nn.ParameterList">ParameterList</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Learnable time constants for each neuron type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.default_neuron_state_init_fn">default_neuron_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default
initialization for neuron states.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.default_feedback_state_init_fn">default_feedback_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default
initialization for feedback states.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.default_output_state_init_fn">default_output_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default
initialization for output states.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.convs">convs</span></code></td>
            <td>
                  <code><span title="torch.nn.ModuleDict">ModuleDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Convolutional layers representing connections between
neuron types.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.out_convs">out_convs</span></code></td>
            <td>
                  <code><span title="torch.nn.ModuleDict">ModuleDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Convolutional layers connecting to the output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="codehilite"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">config</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_neuron_types</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_neuron_subtypes</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">neuron_type_class</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">neuron_type_density</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">neuron_type_nonlinearity</span><span class="o">=</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">inter_neuron_type_connectivity</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
<span class="gp">... </span>    <span class="n">inter_neuron_type_spatial_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">area</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedArea</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatiallyEmbeddedArea</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A biologically-plausible, spatially embedded neural area.</span>

<span class="sd">    This module imposes a series of biologically-inspired constraints on</span>
<span class="sd">    artificial neural networks. At its core, it is a collection of 2D (hence</span>
<span class="sd">    spatially embedded) convolutional layers organized into a &#39;circuit</span>
<span class="sd">    motif&#39;. Here, &#39;circuit motif&#39; refers to the connectivity pattern between</span>
<span class="sd">    the input, feedback, neuron types, and output within a distinct neural</span>
<span class="sd">    area. For example, if we have two neuron types, an excitatory and an</span>
<span class="sd">    inhibitory, then the circuit motif determines which neuron types receive</span>
<span class="sd">    input, which neuron types receive feedback, which neuron types are connected</span>
<span class="sd">    to which other neuron types, and which neuron types project to the output of</span>
<span class="sd">    the area.</span>

<span class="sd">    ## Key features:</span>

<span class="sd">    - Configurable neuron types (excitatory/inhibitory/hybrid)</span>
<span class="sd">    - Configurable spatial extents of lateral connections (same/half)</span>
<span class="sd">    - Convolutional connectivity between neuron populations</span>
<span class="sd">    - Recurrent dynamics with learnable time constants</span>
<span class="sd">    - Optional feedback connections</span>
<span class="sd">    - Customizable activation functions</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_size (tuple[int, int]): Spatial size of the input data</span>
<span class="sd">            (height, width).</span>
<span class="sd">        in_channels (int): Number of input channels.</span>
<span class="sd">        out_channels (int): Number of output channels.</span>
<span class="sd">        feedback_channels (int): Number of feedback channels (0 if none).</span>
<span class="sd">        use_feedback (bool): Whether this area receives feedback from another</span>
<span class="sd">            area.</span>
<span class="sd">        in_class (str): Class of input signal (&quot;excitatory&quot;, &quot;inhibitory&quot;, or</span>
<span class="sd">            &quot;hybrid&quot;).</span>
<span class="sd">        feedback_class (str): Class of feedback signal (&quot;excitatory&quot;, &quot;inhibitory&quot;,</span>
<span class="sd">            or &quot;hybrid&quot;).</span>
<span class="sd">        out_nonlinearity (nn.Module): Nonlinearity applied to the output.</span>

<span class="sd">        num_neuron_types (int): Number of neuron types in the area.</span>
<span class="sd">        num_neuron_subtypes (list[int]): Number of subtypes for each neuron type.</span>
<span class="sd">        neuron_type_class (list[str]): Class of each neuron type (&quot;excitatory&quot;,</span>
<span class="sd">            &quot;inhibitory&quot;, or &quot;hybrid&quot;).</span>
<span class="sd">        neuron_type_density (list[str]): Spatial density of each neuron type</span>
<span class="sd">            (&quot;same&quot; or &quot;half&quot;).</span>
<span class="sd">        neuron_type_nonlinearity (nn.ModuleList): Nonlinearity for each neuron</span>
<span class="sd">            type&#39;s activity.</span>
<span class="sd">        neuron_type_size (list[tuple[int, int]]): Spatial size of each neuron type.</span>

<span class="sd">        num_rows_connectivity (int): Number of rows in the connectivity matrix.</span>
<span class="sd">        num_cols_connectivity (int): Number of columns in the connectivity matrix.</span>
<span class="sd">        inter_neuron_type_connectivity (np.ndarray): Connectivity matrix for the</span>
<span class="sd">            circuit motif.</span>
<span class="sd">        inter_neuron_type_spatial_extents (np.ndarray): Spatial extent for each</span>
<span class="sd">            circuit motif connection.</span>
<span class="sd">        inter_neuron_type_num_subtype_groups (np.ndarray): Number of subtype groups</span>
<span class="sd">            for each circuit motif connection.</span>
<span class="sd">        inter_neuron_type_nonlinearity (np.ndarray): Nonlinearity for each circuit</span>
<span class="sd">            motif connection.</span>
<span class="sd">        inter_neuron_type_bias (np.ndarray): Whether to add a bias term for each</span>
<span class="sd">            circuit motif connection.</span>

<span class="sd">        tau_mode (list[str]): Mode determining which parts of neuron activity share</span>
<span class="sd">            a time constant.</span>
<span class="sd">        tau_init_fn (list[Union[str, TensorInitFnType]]): Initialization for the</span>
<span class="sd">            membrane time constants.</span>
<span class="sd">        tau (nn.ParameterList): Learnable time constants for each neuron type.</span>

<span class="sd">        default_neuron_state_init_fn (Union[str, TensorInitFnType]): Default</span>
<span class="sd">            initialization for neuron states.</span>
<span class="sd">        default_feedback_state_init_fn (Union[str, TensorInitFnType]): Default</span>
<span class="sd">            initialization for feedback states.</span>
<span class="sd">        default_output_state_init_fn (Union[str, TensorInitFnType]): Default</span>
<span class="sd">            initialization for output states.</span>

<span class="sd">        convs (nn.ModuleDict): Convolutional layers representing connections between</span>
<span class="sd">            neuron types.</span>
<span class="sd">        out_convs (nn.ModuleDict): Convolutional layers connecting to the output.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; config = SpatiallyEmbeddedAreaConfig(</span>
<span class="sd">        ...     in_size=(32, 32),</span>
<span class="sd">        ...     in_channels=3,</span>
<span class="sd">        ...     out_channels=16,</span>
<span class="sd">        ...     num_neuron_types=2,</span>
<span class="sd">        ...     num_neuron_subtypes=16,</span>
<span class="sd">        ...     neuron_type_class=[&quot;excitatory&quot;, &quot;inhibitory&quot;],</span>
<span class="sd">        ...     neuron_type_density=[&quot;same&quot;, &quot;half&quot;],</span>
<span class="sd">        ...     neuron_type_nonlinearity=,</span>
<span class="sd">        ...     inter_neuron_type_connectivity=[[1, 0, 0], [1, 1, 1], [1, 0, 0]],</span>
<span class="sd">        ...     inter_neuron_type_spatial_extents=(3, 3),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; area = SpatiallyEmbeddedArea(config)</span>
<span class="sd">        &gt;&gt;&gt; print(area.summary())</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the SpatiallyEmbeddedArea.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration object that specifies the area architecture and parameters.</span>
<span class="sd">                See SpatiallyEmbeddedAreaConfig for details. If None, parameters must be</span>
<span class="sd">                provided as keyword arguments.</span>
<span class="sd">            **kwargs: Keyword arguments to instantiate the configuration if</span>
<span class="sd">                `config` is not provided. Cannot provide both `config` and</span>
<span class="sd">                keyword arguments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an invalid configuration is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot provide both config and keyword arguments. Please provide &quot;</span>
                <span class="s2">&quot;only one of the two.&quot;</span>
            <span class="p">)</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Input, output, and feedback parameters</span>
        <span class="c1">#####################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">out_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">feedback_channels</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_class</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_class</span>
        <span class="n">check_possible_values</span><span class="p">(</span>
            <span class="s2">&quot;in_class&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_class</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback_class</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">feedback_class</span>
        <span class="n">check_possible_values</span><span class="p">(</span>
            <span class="s2">&quot;feedback_class&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_class</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_nonlinearity</span> <span class="o">=</span> <span class="n">get_activation</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">out_nonlinearity</span><span class="p">)</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Neuron type parameters</span>
        <span class="c1">#####################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neuron_types</span>

        <span class="c1"># Format neuron type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>
        <span class="n">check_possible_values</span><span class="p">(</span>
            <span class="s2">&quot;neuron_type_class&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>
        <span class="c1"># TODO: Add support for quarter</span>
        <span class="n">check_possible_values</span><span class="p">(</span>
            <span class="s2">&quot;neuron_type_density&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">get_activation</span><span class="p">(</span><span class="n">nonlinearity</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nonlinearity</span> <span class="ow">in</span> <span class="n">neuron_type_nonlinearity</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Save number of &quot;types&quot; for the input to and output from the area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>  <span class="c1"># input + feedback + neurons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># neurons + output</span>

        <span class="c1"># Calculate half spatial size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">half_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_size</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">half_size</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Circuit motif connectivity</span>
        <span class="c1">#####################################################################</span>

        <span class="c1"># Format circuit connectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The shape of inter_neuron_type_connectivity must match the number of &quot;</span>
                <span class="s2">&quot;rows and columns in the connectivity matrix.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Format connectivity variables to match circuit connectivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Circuit motif convolutions</span>
        <span class="c1"># Here, we represent the circuit connectivity between neuron classes</span>
        <span class="c1"># as an array of convolutions (implemented as a dictionary for</span>
        <span class="c1"># efficiency). The convolution self.convs[f&quot;{i}-&gt;{j}&quot;] corresponds</span>
        <span class="c1"># to the connection from neuron class i to neuron class j.</span>
        <span class="c1">#####################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">):</span>
            <span class="c1"># Handle input neuron channel and spatial mode based on neuron type</span>
            <span class="n">conv_in_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span>
                <span class="n">conv_in_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>
            <span class="k">elif</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
                <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span>
                <span class="n">conv_in_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span>
                <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span>
                    <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">conv_in_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span>
                    <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="n">conv_in_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conv_in_class</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">):</span>
                <span class="n">Conv2d</span> <span class="o">=</span> <span class="n">Conv2dRectify</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">conv_in_class</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span>
                <span class="n">Conv2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span>

            <span class="c1"># Handle output neurons</span>
            <span class="c1"># TODO: Optimize using smart grouping and convolution sharing</span>
            <span class="n">to_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">to_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                    <span class="c1"># Handle output neuron channel and spatial mode based on neuron type</span>
                    <span class="n">conv_out_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination_from_col_idx</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
                        <span class="n">conv_out_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                        <span class="n">conv_out_density</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span>
                        <span class="k">if</span> <span class="n">conv_in_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Input or feedback is connected to output. &quot;</span>
                                <span class="s2">&quot;This is typically undesired as the signal &quot;</span>
                                <span class="s2">&quot;will bypass the neuron types and go directly &quot;</span>
                                <span class="s2">&quot;to the output. Consider removing this &quot;</span>
                                <span class="s2">&quot;connection in the inter_neuron_type_connectivity &quot;</span>
                                <span class="s2">&quot;matrix.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">conv_out_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span>
                        <span class="n">conv_out_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>

                    <span class="c1"># Handle stride upsampling if necessary</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
                    <span class="n">conv_stride</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">conv_in_density</span> <span class="o">==</span> <span class="s2">&quot;half&quot;</span>
                        <span class="ow">and</span> <span class="n">conv_out_density</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
                    <span class="p">):</span>
                        <span class="n">conv_stride</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">conv_in_density</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
                        <span class="ow">and</span> <span class="n">conv_out_density</span> <span class="o">==</span> <span class="s2">&quot;half&quot;</span>
                    <span class="p">):</span>
                        <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Handle upsampling if necessary</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Conv2d</span><span class="p">(</span>
                            <span class="n">in_channels</span><span class="o">=</span><span class="n">conv_in_channels</span><span class="p">,</span>
                            <span class="n">out_channels</span><span class="o">=</span><span class="n">conv_out_channels</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                            <span class="p">],</span>
                            <span class="n">stride</span><span class="o">=</span><span class="n">conv_stride</span><span class="p">,</span>
                            <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span><span class="p">[</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                            <span class="p">],</span>
                            <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">get_activation</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Post convolution operations</span>
        <span class="c1">#####################################################################</span>

        <span class="c1"># Initialize membrane time constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
        <span class="n">check_possible_values</span><span class="p">(</span>
            <span class="s2">&quot;tau_mode&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype_spatial&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_init_fn</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">tau_init_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial&quot;</span><span class="p">:</span>
                <span class="n">tau_channels</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tau_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subtype&quot;</span><span class="p">:</span>
                <span class="n">tau_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tau_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subtype_spatial&quot;</span><span class="p">:</span>
                <span class="n">tau_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tau_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span>
                <span class="n">tau_channels</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tau_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">tau</span> <span class="o">=</span> <span class="n">init_tensor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tau_init_fn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">tau_channels</span><span class="p">,</span>
                <span class="o">*</span><span class="n">tau_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                    <span class="n">tau</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span>
                    <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1">#####################################################################</span>
        <span class="c1"># Tensor initialization</span>
        <span class="c1">#####################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_output_state_init_fn</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_output_state_init_fn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_source_from_row_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts a row index to the corresponding source.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Row index in the circuit connectivity matrix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The source associated with the index. Can be &quot;input&quot;,</span>
<span class="sd">            &quot;feedback&quot;, or &quot;cell&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;input&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;feedback&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;cell&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_class_from_row_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts a row index to the corresponding class.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Row index in the circuit connectivity matrix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The class associated with the index. Can be &quot;excitatory&quot;,</span>
<span class="sd">            &quot;inhibitory&quot;, or &quot;hybrid&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_from_row_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_class</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_destination_from_col_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts a column index to the corresponding destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Column index in the circuit connectivity matrix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The destination associated with the index. Can be &quot;cell&quot; or</span>
<span class="sd">            &quot;output&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;cell&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;output&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clamp_tau</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">:</span>
            <span class="n">tau</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_neuron_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;initializers the neuron hidden states.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization mode. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">                a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">                If a function, it must take a variable number of positional arguments</span>
<span class="sd">                corresponding to the shape of the tensor to initialize, as well</span>
<span class="sd">                as a `device` keyword argument that sends the device to allocate</span>
<span class="sd">                the tensor on.</span>
<span class="sd">            device: Device to allocate the hidden states on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the initialized neuron hidden states.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">init_fn</span>
            <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">init_tensor</span><span class="p">(</span>
                <span class="n">init_fn_corrected</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_output_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the output.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization function. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">                a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">            device: Device to allocate the hidden states on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The initialized output.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">init_fn</span>
            <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_output_state_init_fn</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">init_tensor</span><span class="p">(</span>
            <span class="n">init_fn_corrected</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_feedback_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the feedback input.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization function. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">                a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">            device: Device to allocate the hidden states on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The initialized feedback input if `use_feedback` is True, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">init_fn</span>
            <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">init_tensor</span><span class="p">(</span>
            <span class="n">init_fn_corrected</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">neuron_description_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a DataFrame representing the neuron types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with columns for neuron type, spatial mode, and number of channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_columns</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
            <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;spatial_mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">conv_connectivity_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a DataFrame representing connectivity between neural populations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with rows representing source populations (&quot;from&quot;) and</span>
<span class="sd">            columns representing target populations (&quot;to&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;feedback&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">column_labels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span>

        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;b&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;_&quot;</span>
                    <span class="p">)</span>
                    <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="k">else</span> <span class="s2">&quot;_&quot;</span>
                    <span class="p">)</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">array</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">row_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_labels</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;from&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;to&quot;</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a string representation of the SpatiallyEmbeddedArea.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String representation of the SpatiallyEmbeddedArea.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s2">&quot;SpatiallyEmbeddedArea:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;Connectivity:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_connectivity_df</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;Neuron Description:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_description_df</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">repr_str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">neuron_state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">feedback_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass of the SpatiallyEmbeddedArea.</span>

<span class="sd">        Args:</span>
<span class="sd">            input: Input tensor of shape (batch_size, in_channels, in_size[0], in_size[1]).</span>
<span class="sd">            h_neuron: List of neuron hidden states of shape (batch_size, neuron_channels[i],</span>
<span class="sd">                in_size[0], in_size[1]) for each neuron type i.</span>
<span class="sd">            feedback_state: Feedback input of shape (batch_size, feedback_channels,</span>
<span class="sd">                in_size[0], in_size[1]).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the output and new neuron hidden state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Expand h_neuron to match the number of neuron channels</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neuron_state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;neuron_state must be a list of tensors if num_neuron_types is not 1.&quot;</span>
                <span class="p">)</span>
            <span class="n">neuron_state</span> <span class="o">=</span> <span class="p">[</span><span class="n">neuron_state</span><span class="p">]</span>

        <span class="c1"># Check if feedback is provided if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="o">==</span> <span class="p">(</span><span class="n">feedback_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;use_feedback must be True if and only if feedback_state is provided.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Compute convolutions for each connection in the circuit</span>
        <span class="n">circuit_ins</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">([</span><span class="n">feedback_state</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="n">neuron_state</span>
        <span class="p">)</span>
        <span class="n">circuit_outs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">circuit_outs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">circuit_ins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># Update neuron states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_tau</span><span class="p">()</span>
        <span class="n">neuron_state_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
            <span class="c1"># Aggregate all circuit outputs to this neuron type</span>
            <span class="n">state_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">circuit_outs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">state_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">state_new</span><span class="p">)</span>

            <span class="c1"># Euler update</span>
            <span class="n">state_new</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state_new</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">neuron_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">neuron_state_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_new</span><span class="p">)</span>

        <span class="c1"># Compute output</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">neuron_state_new</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection from </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> to output is not &quot;</span>
                    <span class="s2">&quot;recommended. Consider changing inter_neuron_type_connectivity &quot;</span>
                    <span class="s2">&quot;to remove this connection.&quot;</span>
                <span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">circuit_ins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">neuron_state_new</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize the SpatiallyEmbeddedArea.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="SpatiallyEmbeddedAreaConfig


  
      dataclass
   (src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig)" href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig">SpatiallyEmbeddedAreaConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object that specifies the area architecture and parameters.
See SpatiallyEmbeddedAreaConfig for details. If None, parameters must be
provided as keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments to instantiate the configuration if
<code>config</code> is not provided. Cannot provide both <code>config</code> and
keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an invalid configuration is provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the SpatiallyEmbeddedArea.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration object that specifies the area architecture and parameters.</span>
<span class="sd">            See SpatiallyEmbeddedAreaConfig for details. If None, parameters must be</span>
<span class="sd">            provided as keyword arguments.</span>
<span class="sd">        **kwargs: Keyword arguments to instantiate the configuration if</span>
<span class="sd">            `config` is not provided. Cannot provide both `config` and</span>
<span class="sd">            keyword arguments.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an invalid configuration is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot provide both config and keyword arguments. Please provide &quot;</span>
            <span class="s2">&quot;only one of the two.&quot;</span>
        <span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Input, output, and feedback parameters</span>
    <span class="c1">#####################################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">in_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_channels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">out_channels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">feedback_channels</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">in_class</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">in_class</span>
    <span class="n">check_possible_values</span><span class="p">(</span>
        <span class="s2">&quot;in_class&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_class</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feedback_class</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">feedback_class</span>
    <span class="n">check_possible_values</span><span class="p">(</span>
        <span class="s2">&quot;feedback_class&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_class</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">out_nonlinearity</span> <span class="o">=</span> <span class="n">get_activation</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">out_nonlinearity</span><span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Neuron type parameters</span>
    <span class="c1">#####################################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neuron_types</span>

    <span class="c1"># Format neuron type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>
    <span class="n">check_possible_values</span><span class="p">(</span>
        <span class="s2">&quot;neuron_type_class&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>
    <span class="c1"># TODO: Add support for quarter</span>
    <span class="n">check_possible_values</span><span class="p">(</span>
        <span class="s2">&quot;neuron_type_density&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">get_activation</span><span class="p">(</span><span class="n">nonlinearity</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nonlinearity</span> <span class="ow">in</span> <span class="n">neuron_type_nonlinearity</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Save number of &quot;types&quot; for the input to and output from the area</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>  <span class="c1"># input + feedback + neurons</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span>  <span class="c1"># neurons + output</span>

    <span class="c1"># Calculate half spatial size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">half_size</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">half_size</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Circuit motif connectivity</span>
    <span class="c1">#####################################################################</span>

    <span class="c1"># Format circuit connectivity</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The shape of inter_neuron_type_connectivity must match the number of &quot;</span>
            <span class="s2">&quot;rows and columns in the connectivity matrix.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Format connectivity variables to match circuit connectivity</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Circuit motif convolutions</span>
    <span class="c1"># Here, we represent the circuit connectivity between neuron classes</span>
    <span class="c1"># as an array of convolutions (implemented as a dictionary for</span>
    <span class="c1"># efficiency). The convolution self.convs[f&quot;{i}-&gt;{j}&quot;] corresponds</span>
    <span class="c1"># to the connection from neuron class i to neuron class j.</span>
    <span class="c1">#####################################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">):</span>
        <span class="c1"># Handle input neuron channel and spatial mode based on neuron type</span>
        <span class="n">conv_in_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
            <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span>
            <span class="n">conv_in_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>
        <span class="k">elif</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span>
            <span class="n">conv_in_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">conv_in_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span>
            <span class="n">conv_in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">conv_in_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">conv_in_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conv_in_class</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">):</span>
            <span class="n">Conv2d</span> <span class="o">=</span> <span class="n">Conv2dRectify</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">conv_in_class</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span>
            <span class="n">Conv2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span>

        <span class="c1"># Handle output neurons</span>
        <span class="c1"># TODO: Optimize using smart grouping and convolution sharing</span>
        <span class="n">to_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">to_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                <span class="c1"># Handle output neuron channel and spatial mode based on neuron type</span>
                <span class="n">conv_out_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination_from_col_idx</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
                    <span class="n">conv_out_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                    <span class="n">conv_out_density</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span>
                    <span class="k">if</span> <span class="n">conv_in_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;Input or feedback is connected to output. &quot;</span>
                            <span class="s2">&quot;This is typically undesired as the signal &quot;</span>
                            <span class="s2">&quot;will bypass the neuron types and go directly &quot;</span>
                            <span class="s2">&quot;to the output. Consider removing this &quot;</span>
                            <span class="s2">&quot;connection in the inter_neuron_type_connectivity &quot;</span>
                            <span class="s2">&quot;matrix.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">conv_out_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span>
                    <span class="n">conv_out_density</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>

                <span class="c1"># Handle stride upsampling if necessary</span>
                <span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
                <span class="n">conv_stride</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">conv_in_density</span> <span class="o">==</span> <span class="s2">&quot;half&quot;</span>
                    <span class="ow">and</span> <span class="n">conv_out_density</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
                <span class="p">):</span>
                    <span class="n">conv_stride</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">conv_in_density</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span>
                    <span class="ow">and</span> <span class="n">conv_out_density</span> <span class="o">==</span> <span class="s2">&quot;half&quot;</span>
                <span class="p">):</span>
                    <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Handle upsampling if necessary</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Conv2d</span><span class="p">(</span>
                        <span class="n">in_channels</span><span class="o">=</span><span class="n">conv_in_channels</span><span class="p">,</span>
                        <span class="n">out_channels</span><span class="o">=</span><span class="n">conv_out_channels</span><span class="p">,</span>
                        <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                        <span class="p">],</span>
                        <span class="n">stride</span><span class="o">=</span><span class="n">conv_stride</span><span class="p">,</span>
                        <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_num_subtype_groups</span><span class="p">[</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                        <span class="p">],</span>
                        <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">get_activation</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">conv_out_type</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Post convolution operations</span>
    <span class="c1">#####################################################################</span>

    <span class="c1"># Initialize membrane time constants</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
    <span class="n">check_possible_values</span><span class="p">(</span>
        <span class="s2">&quot;tau_mode&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype_spatial&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tau_init_fn</span> <span class="o">=</span> <span class="n">expand_list</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">tau_init_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial&quot;</span><span class="p">:</span>
            <span class="n">tau_channels</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tau_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subtype&quot;</span><span class="p">:</span>
            <span class="n">tau_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tau_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subtype_spatial&quot;</span><span class="p">:</span>
            <span class="n">tau_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tau_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span>
            <span class="n">tau_channels</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tau_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">init_tensor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau_init_fn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">tau_channels</span><span class="p">,</span>
            <span class="o">*</span><span class="n">tau_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                <span class="n">tau</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span>
                <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Tensor initialization</span>
    <span class="c1">#####################################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_output_state_init_fn</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_output_state_init_fn</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.conv_connectivity_df" class="doc doc-heading">
            <code class=" language-python"><span class="n">conv_connectivity_df</span><span class="p">()</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.conv_connectivity_df" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Creates a DataFrame representing connectivity between neural populations.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with rows representing source populations ("from") and</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>columns representing target populations ("to").</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">conv_connectivity_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a DataFrame representing connectivity between neural populations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with rows representing source populations (&quot;from&quot;) and</span>
<span class="sd">        columns representing target populations (&quot;to&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row_labels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;feedback&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">column_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_rows_connectivity</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cols_connectivity</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;b&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_bias</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;_&quot;</span>
                <span class="p">)</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span> <span class="s2">&quot;_&quot;</span>
                <span class="p">)</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">array</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">row_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_labels</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;from&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;to&quot;</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">neuron_state</span><span class="p">,</span> <span class="n">feedback_state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.forward" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Forward pass of the SpatiallyEmbeddedArea.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input tensor of shape (batch_size, in_channels, in_size[0], in_size[1]).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>h_neuron</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of neuron hidden states of shape (batch_size, neuron_channels[i],
in_size[0], in_size[1]) for each neuron type i.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>feedback_state</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Feedback input of shape (batch_size, feedback_channels,
in_size[0], in_size[1]).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, <span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the output and new neuron hidden state.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">neuron_state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
    <span class="n">feedback_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass of the SpatiallyEmbeddedArea.</span>

<span class="sd">    Args:</span>
<span class="sd">        input: Input tensor of shape (batch_size, in_channels, in_size[0], in_size[1]).</span>
<span class="sd">        h_neuron: List of neuron hidden states of shape (batch_size, neuron_channels[i],</span>
<span class="sd">            in_size[0], in_size[1]) for each neuron type i.</span>
<span class="sd">        feedback_state: Feedback input of shape (batch_size, feedback_channels,</span>
<span class="sd">            in_size[0], in_size[1]).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the output and new neuron hidden state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Expand h_neuron to match the number of neuron channels</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neuron_state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;neuron_state must be a list of tensors if num_neuron_types is not 1.&quot;</span>
            <span class="p">)</span>
        <span class="n">neuron_state</span> <span class="o">=</span> <span class="p">[</span><span class="n">neuron_state</span><span class="p">]</span>

    <span class="c1"># Check if feedback is provided if necessary</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="o">==</span> <span class="p">(</span><span class="n">feedback_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;use_feedback must be True if and only if feedback_state is provided.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Compute convolutions for each connection in the circuit</span>
    <span class="n">circuit_ins</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">([</span><span class="n">feedback_state</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="o">+</span> <span class="n">neuron_state</span>
    <span class="p">)</span>
    <span class="n">circuit_outs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">circuit_outs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">circuit_ins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1"># Update neuron states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_tau</span><span class="p">()</span>
    <span class="n">neuron_state_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
        <span class="c1"># Aggregate all circuit outputs to this neuron type</span>
        <span class="n">state_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">circuit_outs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">state_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">state_new</span><span class="p">)</span>

        <span class="c1"># Euler update</span>
        <span class="n">state_new</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">state_new</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">neuron_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">neuron_state_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_new</span><span class="p">)</span>

    <span class="c1"># Compute output</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_from_row_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">neuron_state_new</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connection from </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> to output is not &quot;</span>
                <span class="s2">&quot;recommended. Consider changing inter_neuron_type_connectivity &quot;</span>
                <span class="s2">&quot;to remove this connection.&quot;</span>
            <span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">conv</span><span class="p">(</span><span class="n">circuit_ins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">neuron_state_new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_feedback_state" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_feedback_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_feedback_state" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the feedback input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function. Must be 'zeros', 'ones', 'randn', 'rand',
a function, or None. If None, the default initialization mode will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate the hidden states on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initialized feedback input if <code>use_feedback</code> is True, otherwise None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_feedback_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the feedback input.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization function. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">            a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">        device: Device to allocate the hidden states on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The initialized feedback input if `use_feedback` is True, otherwise None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">init_fn</span>
        <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">init_tensor</span><span class="p">(</span>
        <span class="n">init_fn_corrected</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback_channels</span><span class="p">,</span>
        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_neuron_state" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_neuron_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_neuron_state" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>initializers the neuron hidden states.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization mode. Must be 'zeros', 'ones', 'randn', 'rand',
a function, or None. If None, the default initialization mode will be used.
If a function, it must take a variable number of positional arguments
corresponding to the shape of the tensor to initialize, as well
as a <code>device</code> keyword argument that sends the device to allocate
the tensor on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate the hidden states on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list containing the initialized neuron hidden states.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_neuron_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;initializers the neuron hidden states.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization mode. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">            a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">            If a function, it must take a variable number of positional arguments</span>
<span class="sd">            corresponding to the shape of the tensor to initialize, as well</span>
<span class="sd">            as a `device` keyword argument that sends the device to allocate</span>
<span class="sd">            the tensor on.</span>
<span class="sd">        device: Device to allocate the hidden states on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list containing the initialized neuron hidden states.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">init_fn</span>
        <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_neuron_state_init_fn</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">init_tensor</span><span class="p">(</span>
            <span class="n">init_fn_corrected</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_output_state" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_output_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.init_output_state" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function. Must be 'zeros', 'ones', 'randn', 'rand',
a function, or None. If None, the default initialization mode will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate the hidden states on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initialized output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_output_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the output.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization function. Must be &#39;zeros&#39;, &#39;ones&#39;, &#39;randn&#39;, &#39;rand&#39;,</span>
<span class="sd">            a function, or None. If None, the default initialization mode will be used.</span>
<span class="sd">        device: Device to allocate the hidden states on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The initialized output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">init_fn_corrected</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">init_fn</span>
        <span class="k">if</span> <span class="n">init_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_output_state_init_fn</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">init_tensor</span><span class="p">(</span>
        <span class="n">init_fn_corrected</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_description_df" class="doc doc-heading">
            <code class=" language-python"><span class="n">neuron_description_df</span><span class="p">()</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.neuron_description_df" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Creates a DataFrame representing the neuron types.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with columns for neuron type, spatial mode, and number of channels.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neuron_description_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a DataFrame representing the neuron types.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with columns for neuron type, spatial mode, and number of channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_columns</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>
        <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_class</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;spatial_mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neuron_type_density</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">df_columns</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neuron_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.summary" class="doc doc-heading">
            <code class=" language-python"><span class="n">summary</span><span class="p">()</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedArea.summary" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Returns a string representation of the SpatiallyEmbeddedArea.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of the SpatiallyEmbeddedArea.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a string representation of the SpatiallyEmbeddedArea.</span>

<span class="sd">    Returns:</span>
<span class="sd">        String representation of the SpatiallyEmbeddedArea.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">repr_str</span> <span class="o">=</span> <span class="s2">&quot;SpatiallyEmbeddedArea:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;Connectivity:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_connectivity_df</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;Neuron Description:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron_description_df</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
    <span class="n">repr_str</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">repr_str</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig" class="doc doc-heading">
            <code>SpatiallyEmbeddedAreaConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Configuration for <code>SpatiallyEmbeddedArea</code>.</p>
<p>This class defines the configuration for a spatially embedded area. It
specifies the size of the input data, the number of input and output
channels, the connectivity matrix for the circuit motif, and the parameters
for the neuron types.</p>
<p>The default configuration corresponds to a spatially embedded area with
one excitatory neuron type which is stimulated by the input and by itself
(lateral connections).</p>
<p>Any of the parameters annotated with <code>ScalarOrListLike</code> can be either a
single value that applies to all neuron types, or a list of values that
apply to each neuron type.</p>
<p>Any of the parameters annotated with <code>ScalarOrArray2dType</code> can be either a
single value that applies to all connections in the circuit motif, or a
2D array that applies to each connection in the circuit motif.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.in_size">in_size</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial size of the input data (height, width).
This size determines the spatial sizes of the feedback signal, the
neuronal states, and the output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.in_channels">in_channels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of input channels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.out_channels">out_channels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of output channels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.feedback_channels">feedback_channels</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of feedback channels. If provided, this area
must receive feedback from another area.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.in_class">in_class</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of input signal. Can be
"excitatory", "inhibitory", or "hybrid".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.feedback_class">feedback_class</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of feedback signal. Can be
"excitatory", "inhibitory", or "hybrid".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.num_neuron_types">num_neuron_types</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of neuron types.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.num_neuron_subtypes">num_neuron_subtypes</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of subtypes for each neuron type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.neuron_type_class">neuron_type_class</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Class of neuron type. Can be
"excitatory", "inhibitory", or "hybrid".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.neuron_type_density">neuron_type_density</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial density of each neuron type. Can be "same"
or "half".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.neuron_type_nonlinearity">neuron_type_nonlinearity</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="torch.nn.Module">Module</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity to apply to each neuron type's
activity after adding the impact of all connected inputs/neuron
types in the circuit motif.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_connectivity">inter_neuron_type_connectivity</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.Array2dType">Array2dType</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="bool">bool</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity matrix for the circuit motif.
The shape should be
(1 + int(use_feedback) + num_neuron_types, num_neuron_types + 1). Here,
rows represent source types and columns represent destination types.
A True entry in the matrix indicates a connection from the source to
the destination.
The first row corresponds to the input, the second row corresponds to
the feedback (if feedback_channels &gt; 0), and the remaining rows
correspond to the neuron types.
The first num_neuron_types columns correspond to the neuron types
and the last column corresponds to the output. To get a template of
the connectivity matrix for your configuration with appropriate row
and column labels, use the <code>inter_neuron_type_connectivity_template_df</code>
method of this class.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_spatial_extents">inter_neuron_type_spatial_extents</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrArray2dType">ScalarOrArray2dType</span>[<span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial extent for each circuit
motif connection. Same shape as <code>inter_neuron_type_connectivity</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_num_subtype_groups">inter_neuron_type_num_subtype_groups</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrArray2dType">ScalarOrArray2dType</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of subtype groups for each
circuit motif connection. Same shape as <code>inter_neuron_type_connectivity</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_nonlinearity">inter_neuron_type_nonlinearity</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrArray2dType">ScalarOrArray2dType</span>[<span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="torch.nn.Module">Module</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity for each circuit motif
connection. Same shape as <code>inter_neuron_type_connectivity</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_bias">inter_neuron_type_bias</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrArray2dType">ScalarOrArray2dType</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add a bias term for each circuit
motif connection. Same shape as <code>inter_neuron_type_connectivity</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.tau_mode">tau_mode</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mode determining which parts of
neuron activity share a time constant. Can be "type" (one tau for each neuron type),
"subtype" (one tau per neuron subtype), "spatial" (one tau per spatial location), or
"subtype_spatial" (one tau per neuron subtype and spatial location)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.tau_init_fn">tau_init_fn</span></code></td>
            <td>
                  <code><span title="bioplnn.typing.ScalarOrListLike">ScalarOrListLike</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization mode for the membrane time constants.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.out_nonlinearity">out_nonlinearity</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="torch.nn.Module">Module</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearity to apply to the output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.default_neuron_state_init_fn">default_neuron_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization mode for the hidden state.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.default_feedback_state_init_fn">default_feedback_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization mode for the feedback state.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.default_output_state_init_fn">default_output_state_init_fn</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization mode for the output state.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="codehilite"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="o">.</span><span class="n">inter_neuron_type_connectivity_template_df</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">use_feedback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_neuron_types</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">connectivity_df</span><span class="p">)</span>
<span class="go">                destination</span>
<span class="go">source          neuron_0  neuron_1  output</span>
<span class="go">input           False     False     False</span>
<span class="go">neuron_0        False     False     False</span>
<span class="go">neuron_1        False     False     False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;neuron_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;neuron_0&quot;</span><span class="p">,</span> <span class="s2">&quot;neuron_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;neuron_0&quot;</span><span class="p">,</span> <span class="s2">&quot;neuron_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;neuron_1&quot;</span><span class="p">,</span> <span class="s2">&quot;neuron_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;neuron_0&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">config</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">inter_neuron_type_connectivity</span><span class="o">=</span><span class="n">connectivity_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpatiallyEmbeddedAreaConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for `SpatiallyEmbeddedArea`.</span>

<span class="sd">    This class defines the configuration for a spatially embedded area. It</span>
<span class="sd">    specifies the size of the input data, the number of input and output</span>
<span class="sd">    channels, the connectivity matrix for the circuit motif, and the parameters</span>
<span class="sd">    for the neuron types.</span>

<span class="sd">    The default configuration corresponds to a spatially embedded area with</span>
<span class="sd">    one excitatory neuron type which is stimulated by the input and by itself</span>
<span class="sd">    (lateral connections).</span>

<span class="sd">    Any of the parameters annotated with `ScalarOrListLike` can be either a</span>
<span class="sd">    single value that applies to all neuron types, or a list of values that</span>
<span class="sd">    apply to each neuron type.</span>

<span class="sd">    Any of the parameters annotated with `ScalarOrArray2dType` can be either a</span>
<span class="sd">    single value that applies to all connections in the circuit motif, or a</span>
<span class="sd">    2D array that applies to each connection in the circuit motif.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_size: Spatial size of the input data (height, width).</span>
<span class="sd">            This size determines the spatial sizes of the feedback signal, the</span>
<span class="sd">            neuronal states, and the output.</span>
<span class="sd">        in_channels: Number of input channels.</span>
<span class="sd">        out_channels: Number of output channels.</span>
<span class="sd">        feedback_channels: Number of feedback channels. If provided, this area</span>
<span class="sd">            must receive feedback from another area.</span>
<span class="sd">        in_class: Class of input signal. Can be</span>
<span class="sd">            &quot;excitatory&quot;, &quot;inhibitory&quot;, or &quot;hybrid&quot;.</span>
<span class="sd">        feedback_class: Class of feedback signal. Can be</span>
<span class="sd">            &quot;excitatory&quot;, &quot;inhibitory&quot;, or &quot;hybrid&quot;.</span>
<span class="sd">        num_neuron_types: Number of neuron types.</span>
<span class="sd">        num_neuron_subtypes: Number of subtypes for each neuron type.</span>
<span class="sd">        neuron_type_class: Class of neuron type. Can be</span>
<span class="sd">            &quot;excitatory&quot;, &quot;inhibitory&quot;, or &quot;hybrid&quot;.</span>
<span class="sd">        neuron_type_density: Spatial density of each neuron type. Can be &quot;same&quot;</span>
<span class="sd">            or &quot;half&quot;.</span>
<span class="sd">        neuron_type_nonlinearity: Nonlinearity to apply to each neuron type&#39;s</span>
<span class="sd">            activity after adding the impact of all connected inputs/neuron</span>
<span class="sd">            types in the circuit motif.</span>
<span class="sd">        inter_neuron_type_connectivity: Connectivity matrix for the circuit motif.</span>
<span class="sd">            The shape should be</span>
<span class="sd">            (1 + int(use_feedback) + num_neuron_types, num_neuron_types + 1). Here,</span>
<span class="sd">            rows represent source types and columns represent destination types.</span>
<span class="sd">            A True entry in the matrix indicates a connection from the source to</span>
<span class="sd">            the destination.</span>
<span class="sd">            The first row corresponds to the input, the second row corresponds to</span>
<span class="sd">            the feedback (if feedback_channels &gt; 0), and the remaining rows</span>
<span class="sd">            correspond to the neuron types.</span>
<span class="sd">            The first num_neuron_types columns correspond to the neuron types</span>
<span class="sd">            and the last column corresponds to the output. To get a template of</span>
<span class="sd">            the connectivity matrix for your configuration with appropriate row</span>
<span class="sd">            and column labels, use the `inter_neuron_type_connectivity_template_df`</span>
<span class="sd">            method of this class.</span>
<span class="sd">        inter_neuron_type_spatial_extents: Spatial extent for each circuit</span>
<span class="sd">            motif connection. Same shape as `inter_neuron_type_connectivity`.</span>
<span class="sd">        inter_neuron_type_num_subtype_groups: Number of subtype groups for each</span>
<span class="sd">            circuit motif connection. Same shape as `inter_neuron_type_connectivity`.</span>
<span class="sd">        inter_neuron_type_nonlinearity: Nonlinearity for each circuit motif</span>
<span class="sd">            connection. Same shape as `inter_neuron_type_connectivity`.</span>
<span class="sd">        inter_neuron_type_bias: Whether to add a bias term for each circuit</span>
<span class="sd">            motif connection. Same shape as `inter_neuron_type_connectivity`.</span>
<span class="sd">        tau_mode: Mode determining which parts of</span>
<span class="sd">            neuron activity share a time constant. Can be &quot;type&quot; (one tau for each neuron type),</span>
<span class="sd">            &quot;subtype&quot; (one tau per neuron subtype), &quot;spatial&quot; (one tau per spatial location), or</span>
<span class="sd">            &quot;subtype_spatial&quot; (one tau per neuron subtype and spatial location)</span>
<span class="sd">        tau_init_fn: Initialization mode for the membrane time constants.</span>
<span class="sd">        out_nonlinearity: Nonlinearity to apply to the output.</span>
<span class="sd">        default_neuron_state_init_fn: Initialization mode for the hidden state.</span>
<span class="sd">        default_feedback_state_init_fn: Initialization mode for the feedback state.</span>
<span class="sd">        default_output_state_init_fn: Initialization mode for the output state.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df = SpatiallyEmbeddedAreaConfig.inter_neuron_type_connectivity_template_df(</span>
<span class="sd">        ...     use_feedback=False,</span>
<span class="sd">        ...     num_neuron_types=2,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(connectivity_df)</span>
<span class="sd">                        destination</span>
<span class="sd">        source          neuron_0  neuron_1  output</span>
<span class="sd">        input           False     False     False</span>
<span class="sd">        neuron_0        False     False     False</span>
<span class="sd">        neuron_1        False     False     False</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df.loc[&quot;input&quot;, &quot;neuron_0&quot;] = True</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df.loc[&quot;neuron_0&quot;, &quot;neuron_0&quot;] = True</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df.loc[&quot;neuron_0&quot;, &quot;neuron_1&quot;] = True</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df.loc[&quot;neuron_1&quot;, &quot;neuron_0&quot;] = True</span>
<span class="sd">        &gt;&gt;&gt; connectivity_df.loc[&quot;neuron_0&quot;, &quot;output&quot;] = True</span>
<span class="sd">        &gt;&gt;&gt; config = SpatiallyEmbeddedAreaConfig(</span>
<span class="sd">        ...     in_size=(32, 32),</span>
<span class="sd">        ...     in_channels=3,</span>
<span class="sd">        ...     out_channels=16,</span>
<span class="sd">        ...     inter_neuron_type_connectivity=connectivity_df.to_numpy(),</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Input, output, and feedback parameters</span>
    <span class="n">in_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">out_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">feedback_channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">in_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span>
    <span class="n">feedback_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span>

    <span class="c1"># Neuron type parameters</span>
    <span class="n">num_neuron_types</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">num_neuron_subtypes</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">neuron_type_class</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span>
    <span class="n">neuron_type_density</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span>
    <span class="n">neuron_type_nonlinearity</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Sigmoid&quot;</span>
    <span class="n">tau_mode</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;subtype&quot;</span>
    <span class="n">tau_init_fn</span><span class="p">:</span> <span class="n">ScalarOrListLike</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;ones&quot;</span>

    <span class="c1"># Circuit motif connectivity parameters</span>
    <span class="n">inter_neuron_type_connectivity</span><span class="p">:</span> <span class="n">Array2dType</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="n">inter_neuron_type_spatial_extents</span><span class="p">:</span> <span class="n">ScalarOrArray2dType</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inter_neuron_type_num_subtype_groups</span><span class="p">:</span> <span class="n">ScalarOrArray2dType</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">inter_neuron_type_nonlinearity</span><span class="p">:</span> <span class="n">ScalarOrArray2dType</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inter_neuron_type_bias</span><span class="p">:</span> <span class="n">ScalarOrArray2dType</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">out_nonlinearity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default_neuron_state_init_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zeros&quot;</span>
    <span class="n">default_feedback_state_init_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zeros&quot;</span>
    <span class="n">default_output_state_init_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zeros&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the configuration object to a dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: Dictionary representation of the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inter_neuron_type_connectivity_template_df</span><span class="p">(</span>
        <span class="n">use_feedback</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">num_neuron_types</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Samples the inter-neuron type connectivity matrix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame representation of the connectivity matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;feedback&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neuron_types</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">column_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neuron_types</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;output&quot;</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">row_labels</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">column_labels</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.asdict" class="doc doc-heading">
            <code class=" language-python"><span class="n">asdict</span><span class="p">()</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.asdict" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Converts the configuration object to a dictionary.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, Any]: Dictionary representation of the configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts the configuration object to a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, Any]: Dictionary representation of the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_connectivity_template_df" class="doc doc-heading">
            <code class=" language-python"><span class="n">inter_neuron_type_connectivity_template_df</span><span class="p">(</span><span class="n">use_feedback</span><span class="p">,</span> <span class="n">num_neuron_types</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig.inter_neuron_type_connectivity_template_df" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Samples the inter-neuron type connectivity matrix.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: DataFrame representation of the connectivity matrix.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">inter_neuron_type_connectivity_template_df</span><span class="p">(</span>
    <span class="n">use_feedback</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">num_neuron_types</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Samples the inter-neuron type connectivity matrix.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame representation of the connectivity matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row_labels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;feedback&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_feedback</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neuron_types</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">column_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;neuron_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neuron_types</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s2">&quot;output&quot;</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">row_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">row_labels</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">column_labels</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN" class="doc doc-heading">
            <code>SpatiallyEmbeddedRNN</code>


<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>Spatially embedded RNN.</p>
<p>This module stacks multiple SpatiallyEmbeddedArea instances with optional
feedback connections between them.
It handles spatial dimension matching between areas and provides a
flexible interface for configuring the network.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.num_areas">num_areas</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of SpatiallyEmbeddedArea instances in the network.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.areas">areas</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ModuleList containing the SpatiallyEmbeddedArea instances.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.feedback_convs">feedback_convs</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ModuleDict of feedback convolution layers between areas.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.area_time_delay">area_time_delay</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to introduce a time delay between areas.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.pool_mode">pool_mode</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pooling mode for area outputs ('max' or 'avg').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.batch_first">batch_first</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether input has batch dimension as the first dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.inter_area_feedback_connectivity">inter_area_feedback_connectivity</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity matrix for feedback
connections between areas.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.inter_area_feedback_nonlinearity">inter_area_feedback_nonlinearity</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearities for feedback
connections between areas.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.inter_area_feedback_spatial_extents">inter_area_feedback_spatial_extents</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kernel sizes for feedback
convolutions between areas.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="codehilite"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a SpatiallyEmbeddedRNN with 2 areas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">area_configs</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">feedback_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">in_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">feedback_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="gp">... </span>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rnn</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedRNN</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">num_areas</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">area_configs</span><span class="o">=</span><span class="n">area_configs</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">inter_area_feedback_connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a SpatiallyEmbeddedRNN with 2 areas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">area_configs</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)),</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">in_size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rnn</span> <span class="o">=</span> <span class="n">SpatiallyEmbeddedRNN</span><span class="p">(</span><span class="n">num_areas</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">area_configs</span><span class="o">=</span><span class="n">area_configs</span><span class="p">)</span>
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatiallyEmbeddedRNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spatially embedded RNN.</span>

<span class="sd">    This module stacks multiple SpatiallyEmbeddedArea instances with optional</span>
<span class="sd">    feedback connections between them.</span>
<span class="sd">    It handles spatial dimension matching between areas and provides a</span>
<span class="sd">    flexible interface for configuring the network.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        num_areas: Number of SpatiallyEmbeddedArea instances in the network.</span>
<span class="sd">        areas: ModuleList containing the SpatiallyEmbeddedArea instances.</span>
<span class="sd">        feedback_convs: ModuleDict of feedback convolution layers between areas.</span>
<span class="sd">        area_time_delay: Whether to introduce a time delay between areas.</span>
<span class="sd">        pool_mode: Pooling mode for area outputs (&#39;max&#39; or &#39;avg&#39;).</span>
<span class="sd">        batch_first: Whether input has batch dimension as the first dimension.</span>
<span class="sd">        inter_area_feedback_connectivity: Connectivity matrix for feedback</span>
<span class="sd">            connections between areas.</span>
<span class="sd">        inter_area_feedback_nonlinearity: Nonlinearities for feedback</span>
<span class="sd">            connections between areas.</span>
<span class="sd">        inter_area_feedback_spatial_extents: Kernel sizes for feedback</span>
<span class="sd">            convolutions between areas.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Create a SpatiallyEmbeddedRNN with 2 areas</span>
<span class="sd">        &gt;&gt;&gt; area_configs = [</span>
<span class="sd">        ...     SpatiallyEmbeddedAreaConfig(</span>
<span class="sd">        ...         in_channels=1,</span>
<span class="sd">        ...         out_channels=16,</span>
<span class="sd">        ...         in_size=(64, 64),</span>
<span class="sd">        ...         feedback_channels=16,</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ...     SpatiallyEmbeddedAreaConfig(</span>
<span class="sd">        ...         in_channels=16,</span>
<span class="sd">        ...         out_channels=32,</span>
<span class="sd">        ...         in_size=(32, 32),</span>
<span class="sd">        ...         feedback_channels=32,</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; connectivity = [</span>
<span class="sd">        ...     [0, 0],</span>
<span class="sd">        ...     [1, 0]</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; rnn = SpatiallyEmbeddedRNN(</span>
<span class="sd">        ...     num_areas=2,</span>
<span class="sd">        ...     area_configs=area_configs,</span>
<span class="sd">        ...     inter_area_feedback_connectivity=connectivity,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # Create a SpatiallyEmbeddedRNN with 2 areas</span>
<span class="sd">        &gt;&gt;&gt; area_configs = [</span>
<span class="sd">        &gt;&gt;&gt;     SpatiallyEmbeddedAreaConfig(in_channels=1, out_channels=16, in_size=(64, 64)),</span>
<span class="sd">        &gt;&gt;&gt;     SpatiallyEmbeddedAreaConfig(in_channels=16, out_channels=32, in_size=(32, 32)),</span>
<span class="sd">        &gt;&gt;&gt; ]</span>
<span class="sd">        &gt;&gt;&gt; rnn = SpatiallyEmbeddedRNN(num_areas=2, area_configs=area_configs)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_areas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">area_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">area_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">common_area_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inter_area_feedback_connectivity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">InterAreaParam</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inter_area_feedback_nonlinearity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">InterAreaParam</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inter_area_feedback_spatial_extents</span><span class="p">:</span> <span class="n">InterAreaParam</span><span class="p">[</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">area_time_delay</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pool_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
        <span class="n">batch_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the SpatiallyEmbeddedRNN.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_areas: Number of `SpatiallyEmbeddedArea` instances in the network.</span>
<span class="sd">            area_configs: Configuration object(s) for the `SpatiallyEmbeddedArea` instances.</span>
<span class="sd">                If provided as a list, must match the number of areas. If a single config</span>
<span class="sd">                is provided, it will be used for all areas with appropriate adjustments.</span>
<span class="sd">            area_kwargs: Additional keyword arguments for each area. If provided as a list,</span>
<span class="sd">                must match the number of areas.</span>
<span class="sd">            common_area_kwargs: Keyword arguments to apply to all areas.</span>
<span class="sd">            inter_area_feedback_connectivity: Connectivity matrix for feedback connections</span>
<span class="sd">                between areas of shape (num_areas, num_areas). Must be lower triangular and</span>
<span class="sd">                zero/False on the diagonal.</span>
<span class="sd">            inter_area_feedback_nonlinearity: Nonlinearities for feedback connections of</span>
<span class="sd">                shape (num_areas, num_areas).</span>
<span class="sd">            inter_area_feedback_spatial_extents: Kernel sizes for feedback convolutions</span>
<span class="sd">                of shape (num_areas, num_areas).</span>
<span class="sd">            pool_mode: Pooling mode for area outputs.</span>
<span class="sd">            area_time_delay: Whether to introduce a time delay between areas.</span>
<span class="sd">            batch_first: Whether the input tensor has batch dimension as the first dimension.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any of the provided parameters are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1">############################################################</span>
        <span class="c1"># Area configs</span>
        <span class="c1">############################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span> <span class="o">=</span> <span class="n">num_areas</span>

        <span class="k">if</span> <span class="n">area_configs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">area_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;area_configs cannot be provided if area_configs_kwargs &quot;</span>
                    <span class="s2">&quot;or common_area_config_kwargs is provided.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">area_configs</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;area_configs must be of length num_areas.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;area_kwargs or common_area_kwargs must be provided if &quot;</span>
                        <span class="s2">&quot;area_configs is not provided.&quot;</span>
                    <span class="p">)</span>
                <span class="n">area_kwargs</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>  <span class="c1"># type: ignore</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">area_kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;area_kwargs must be of length num_areas.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">common_area_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">area_configs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">common_area_kwargs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">area_kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Validate area configurations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">area_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">!=</span> <span class="n">area_configs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">in_channels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The output channels of area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must match the input &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;channels of area </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="c1">############################################################</span>
        <span class="c1"># RNN parameters</span>
        <span class="c1">############################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">area_time_delay</span> <span class="o">=</span> <span class="n">area_time_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_mode</span> <span class="o">=</span> <span class="n">pool_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span> <span class="o">=</span> <span class="n">batch_first</span>

        <span class="c1">############################################################</span>
        <span class="c1"># Initialize areas</span>
        <span class="c1">############################################################</span>

        <span class="c1"># Create areas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">SpatiallyEmbeddedArea</span><span class="p">(</span><span class="n">area_config</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">area_config</span> <span class="ow">in</span> <span class="n">area_configs</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1">############################################################</span>
        <span class="c1"># Initialize feedback connections</span>
        <span class="c1">############################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">inter_area_feedback_connectivity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">area_config</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="k">for</span> <span class="n">area_config</span> <span class="ow">in</span> <span class="n">area_configs</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;inter_area_feedback_connectivity must be provided if and only if &quot;</span>
                    <span class="s2">&quot;feedback_channels is provided for at least one area.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">inter_area_feedback_connectivity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The shape of inter_area_feedback_connectivity must be (num_areas, num_areas).&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_nonlinearity</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
                <span class="n">inter_area_feedback_nonlinearity</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
                <span class="n">inter_area_feedback_spatial_extents</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Validate inter_area_feedback_connectivity tensor</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The dimensions of inter_area_feedback_connectivity must match the number of areas.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;inter_area_feedback_connectivity must be a non-zero tensor if provided.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create feedback convolutions</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="p">):</span>
                <span class="n">nonzero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nonzero_indices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;the feedback connection from area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;is not valid because feedback connections must &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;pass information from later areas to earlier &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;areas (i.e. inter_area_feedback_connectivity must &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;be lower triangular and zero on the diagonal).&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;the connection from area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> is &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;not valid because area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> does not receive &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;feedback (hint: feedback_channels may not be provided)&quot;</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                        <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span>
                            <span class="n">size</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                            <span class="n">in_channels</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
                            <span class="n">out_channels</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">feedback_channels</span><span class="p">,</span>
                            <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span>
                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                            <span class="p">],</span>
                            <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span>
                                    <span class="mi">0</span>
                                <span class="p">]</span>
                                <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span>
                                    <span class="mi">1</span>
                                <span class="p">]</span>
                                <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">bias</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span>
                                <span class="n">j</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">get_activation</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_neuron_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the hidden states for all areas.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization function.</span>
<span class="sd">            device: Device to allocate tensors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the initialized neuron hidden states for each area.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">area</span><span class="o">.</span><span class="n">init_neuron_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_feedback_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the feedback inputs for all areas.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization function.</span>
<span class="sd">            device: Device to allocate tensors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of initialized feedback inputs for each area.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">area</span><span class="o">.</span><span class="n">init_feedback_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_output_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the outputs for all areas.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            init_fn: Initialization function.</span>
<span class="sd">            device: Device to allocate tensors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of initialized outputs for each area.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">area</span><span class="o">.</span><span class="n">init_output_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">out0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
        <span class="n">h_neuron0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]],</span>
        <span class="n">fb0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">out_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fb_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]],</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the state of the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            out0: Initial outputs for each area. If None, default initialization is used.</span>
<span class="sd">            h_neuron0: Initial neuron hidden states for each area. If None, default</span>
<span class="sd">                initialization is used.</span>
<span class="sd">            fb0: Initial feedback inputs for each area. If None, default initialization is used.</span>
<span class="sd">            num_steps: Number of time steps.</span>
<span class="sd">            batch_size: Batch size.</span>
<span class="sd">            out_init_fn: Initialization function for outputs if out0 is None. Defaults to None.</span>
<span class="sd">            hidden_init_fn: Initialization function for hidden states if h_neuron0 is None.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            fb_init_fn: Initialization function for feedback inputs if fb0 is None.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            device: Device to allocate tensors on. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - Initialized outputs for each area and time step</span>
<span class="sd">            - Initialized neuron hidden states for each area, time step, and neuron type</span>
<span class="sd">            - Initialized feedback inputs for each area and time step</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the length of out0, h_neuron0, or fb0 doesn&#39;t match</span>
<span class="sd">                the number of areas.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate input shapes of out0, h_neuron0, fb0</span>
        <span class="k">if</span> <span class="n">out0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out0</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">out0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The length of out0 must be equal to the number of areas.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">h_neuron0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h_neuron0</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_neuron0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The length of h_neuron0 must be equal to the number of areas.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">fb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fb0</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fb0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The length of fb0 must be equal to the number of areas.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Initialize default values</span>
        <span class="n">h_neuron0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_neuron_states</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_init_fn</span><span class="p">,</span> <span class="n">device</span>
        <span class="p">)</span>
        <span class="n">fb0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_feedback_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">fb_init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">out0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_output_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">out_init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="c1"># Initialize output, hidden state, and feedback lists</span>
        <span class="n">outs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_steps</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">h_neurons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">fbs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_steps</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Fill time step -1 with the initial values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">):</span>
            <span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">out0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out0_default</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">fb0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fb0_default</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="n">h_neurons</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">h_neuron0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">h_neuron0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">h_neuron0_default</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="n">h_neurons</span><span class="p">,</span> <span class="n">fbs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_x</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Formats the input tensor to match the expected shape.</span>

<span class="sd">        This method handles both single-step (4D) and multi-step (5D) input tensors,</span>
<span class="sd">        converting them to a consistent format with seq_len as the first dimension.</span>
<span class="sd">        For 4D inputs, it replicates the input across all time steps.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor, can be:</span>
<span class="sd">                - 4D tensor of shape (batch_size, channels, height, width) for a</span>
<span class="sd">                  single time step. Will be expanded to all time steps.</span>
<span class="sd">                - 5D tensor of shape (seq_len, batch_size, channels, height, width) or</span>
<span class="sd">                  (batch_size, seq_len, channels, height, width) if batch_first=True.</span>
<span class="sd">            num_steps: Number of time steps. Required if x is 4D.</span>
<span class="sd">                If x is 5D, it will be inferred from the sequence dimension unless</span>
<span class="sd">                explicitly provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - The formatted input tensor with shape (seq_len, batch_size, channels, height, width)</span>
<span class="sd">            - The number of time steps</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If x has invalid dimensions (not 4D or 5D), if num_steps is</span>
<span class="sd">                not provided for 4D inputs, or if num_steps is inconsistent with</span>
<span class="sd">                the sequence length of 5D inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_steps</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;If x is 4D, num_steps must be provided and greater than 0&quot;</span>
                <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_steps</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;If x is 5D and num_steps is provided, it must match the sequence length.&quot;</span>
                <span class="p">)</span>
            <span class="n">num_steps</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The input must be a 4D tensor or a 5D tensor with sequence length.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">h_neurons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]],</span>
        <span class="n">fbs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Formats the outputs, hidden states, and feedback inputs for return.</span>

<span class="sd">        This method stacks tensors across time steps and applies batch_first</span>
<span class="sd">        transposition if needed. Each tensor has shape (batch_size, channels,</span>
<span class="sd">        height, width).</span>

<span class="sd">        Args:</span>
<span class="sd">            outs: Outputs for each area and time step. Shape: [num_areas][num_steps],</span>
<span class="sd">            h_neurons: Neuron hidden states for each area, time step, and neuron type.</span>
<span class="sd">                Shape: [num_areas][num_steps][num_neuron_types].</span>
<span class="sd">            fbs: Feedback inputs for each area and time step. Shape: [num_areas][num_steps].</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - List of stacked outputs per area. Each tensor has shape:</span>
<span class="sd">              (seq_len, batch_size, channels, height, width) or</span>
<span class="sd">              (batch_size, seq_len, channels, height, width) if batch_first=True.</span>
<span class="sd">            - List of lists of stacked hidden states per area and neuron type.</span>
<span class="sd">              Same shape pattern as outputs.</span>
<span class="sd">            - List of stacked feedback inputs per area (or None if not used).</span>
<span class="sd">              Same shape pattern as outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outs_stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">h_neurons_stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fbs_stack</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">):</span>
            <span class="n">outs_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">h_neurons_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">h_neurons</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_neurons</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
                <span class="n">fbs_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">feedback_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">feedback_state</span> <span class="ow">in</span> <span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">fbs_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span><span class="p">:</span>
                <span class="n">outs_stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outs_stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                    <span class="n">h_neurons_stack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_neurons_stack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
                    <span class="n">fbs_stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbs_stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">return</span> <span class="n">outs_stack</span><span class="p">,</span> <span class="n">h_neurons_stack</span><span class="p">,</span> <span class="n">fbs_stack</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_match_spatial_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjusts the spatial dimensions of the input tensor.</span>

<span class="sd">        This method ensures that tensors have compatible spatial dimensions when</span>
<span class="sd">        passing between areas. It uses either pooling (when downsampling) or</span>
<span class="sd">        interpolation (when upsampling).</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor of shape (batch_size, channels, height, width).</span>
<span class="sd">            size: Target spatial size (height, width).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Resized tensor matching the target spatial size.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If self.pool_mode is not &#39;avg&#39; or &#39;max&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_mode</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">adaptive_max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid pool_mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_neuron_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">neuron_states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">area</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">neuron_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">time_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">neuron_subtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spatial_location_i</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spatial_location_j</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the model states for a given area, time step, neuron type, neuron subtype, and spatial location.</span>

<span class="sd">        Args:</span>
<span class="sd">            neuron_states: List of lists of tensors containing the model states.</span>
<span class="sd">            area: The area index.</span>
<span class="sd">            neuron_type: The neuron type index.</span>
<span class="sd">            time_step: The time step index. If not provided, all time steps are returned.</span>
<span class="sd">            batch: The batch index. If not provided, all batches are returned.</span>
<span class="sd">            neuron_subtype: The neuron subtype index. If not provided, all neuron subtypes are returned.</span>
<span class="sd">            spatial_location_i: The spatial location (height). If not provided, all spatial locations are returned.</span>
<span class="sd">            spatial_location_j: The spatial location (width). If not provided, all spatial locations are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The queried state of shape (batch_size_slice, channels, height, width)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">time_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_idx</span> <span class="o">=</span> <span class="n">time_step</span>
        <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="k">if</span> <span class="n">neuron_subtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neuron_subtype_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neuron_subtype_idx</span> <span class="o">=</span> <span class="n">neuron_subtype</span>
        <span class="k">if</span> <span class="n">spatial_location_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spatial_location_idx_i</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spatial_location_idx_i</span> <span class="o">=</span> <span class="n">spatial_location_i</span>
        <span class="k">if</span> <span class="n">spatial_location_j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spatial_location_idx_j</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spatial_location_idx_j</span> <span class="o">=</span> <span class="n">spatial_location_j</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">area</span><span class="p">][</span><span class="n">neuron_type</span><span class="p">][</span>
                <span class="n">batch_idx</span><span class="p">,</span>
                <span class="n">time_idx</span><span class="p">,</span>
                <span class="n">neuron_subtype_idx</span><span class="p">,</span>
                <span class="n">spatial_location_idx_i</span><span class="p">,</span>
                <span class="n">spatial_location_idx_j</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">area</span><span class="p">][</span><span class="n">neuron_type</span><span class="p">][</span>
                <span class="n">time_idx</span><span class="p">,</span>
                <span class="n">batch_idx</span><span class="p">,</span>
                <span class="n">neuron_subtype_idx</span><span class="p">,</span>
                <span class="n">spatial_location_idx_i</span><span class="p">,</span>
                <span class="n">spatial_location_idx_j</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">neuron_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feedback_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs forward pass of the SpatiallyEmbeddedRNN.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor. Can be either:</span>
<span class="sd">                - 4D tensor of shape (batch_size, in_channels, height, width)</span>
<span class="sd">                  representing a single time step. In this case, num_steps must be</span>
<span class="sd">                  provided.</span>
<span class="sd">                - 5D tensor of shape (seq_len, batch_size, in_channels, height, width)</span>
<span class="sd">                  or (batch_size, seq_len, in_channels, height, width) if</span>
<span class="sd">                  batch_first=True.</span>
<span class="sd">            num_steps: Number of time steps. Required if x is 4D.</span>
<span class="sd">                If x is 5D, this must match the sequence length dimension in x.</span>
<span class="sd">            output_state0: Initial outputs for each area. Length should match the</span>
<span class="sd">                number of areas. Each element can be None to use default initialization.</span>
<span class="sd">            neuron_state0: Initial neuron hidden states for each area and neuron type.</span>
<span class="sd">                Length should match the number of areas, and each inner sequence length</span>
<span class="sd">                should match the number of neuron types in that area.</span>
<span class="sd">            feedback_state0: Initial feedback inputs for each area. Length should match</span>
<span class="sd">                the number of areas.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - Outputs for each area. Each tensor has shape:</span>
<span class="sd">              (seq_len, batch_size, out_channels, height, width) or</span>
<span class="sd">              (batch_size, seq_len, out_channels, height, width) if batch_first=True.</span>
<span class="sd">            - Hidden states for each area and neuron type.</span>
<span class="sd">              Same shape pattern as outputs but with neuron_channels.</span>
<span class="sd">            - Feedback inputs for each area (None if the area doesn&#39;t use feedback).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If input shape is invalid or num_steps is inconsistent with</span>
<span class="sd">                the input shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_states</span><span class="p">(</span>
            <span class="n">output_state0</span><span class="p">,</span>
            <span class="n">neuron_state0</span><span class="p">,</span>
            <span class="n">feedback_state0</span><span class="p">,</span>
            <span class="n">num_steps</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">):</span>
                <span class="c1"># Compute area update and output</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">area_in</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_time_delay</span><span class="p">:</span>
                        <span class="n">area_in</span> <span class="o">=</span> <span class="n">output_states</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">area_in</span> <span class="o">=</span> <span class="n">output_states</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">area_in</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                    <span class="n">area_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_spatial_size</span><span class="p">(</span>
                        <span class="n">area_in</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="p">)</span>

                <span class="n">output_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">],</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="p">(</span>
                    <span class="nb">input</span><span class="o">=</span><span class="n">area_in</span><span class="p">,</span>
                    <span class="n">neuron_state</span><span class="o">=</span><span class="n">neuron_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">feedback_state</span><span class="o">=</span><span class="n">feedback_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="c1"># Apply feedback</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">area_i</span><span class="p">,</span> <span class="n">area_j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
                <span class="n">area_i</span><span class="p">,</span> <span class="n">area_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">area_i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">area_j</span><span class="p">)</span>
                <span class="n">feedback_states</span><span class="p">[</span><span class="n">area_j</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">feedback_states</span><span class="p">[</span><span class="n">area_j</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">(</span>
                    <span class="n">output_states</span><span class="p">[</span><span class="n">area_i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">(</span>
            <span class="n">output_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">neuron_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">feedback_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_areas</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">area_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">area_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">common_area_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inter_area_feedback_connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inter_area_feedback_nonlinearity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inter_area_feedback_spatial_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">area_time_delay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pool_mode</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize the SpatiallyEmbeddedRNN.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_areas</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of <code>SpatiallyEmbeddedArea</code> instances in the network.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_configs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="SpatiallyEmbeddedAreaConfig


  
      dataclass
   (src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig)" href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedAreaConfig">SpatiallyEmbeddedAreaConfig</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object(s) for the <code>SpatiallyEmbeddedArea</code> instances.
If provided as a list, must match the number of areas. If a single config
is provided, it will be used for all areas with appropriate adjustments.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="collections.abc.Mapping">Mapping</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for each area. If provided as a list,
must match the number of areas.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>common_area_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Mapping">Mapping</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments to apply to all areas.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inter_area_feedback_connectivity</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bioplnn.typing.InterAreaParam">InterAreaParam</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="bool">bool</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Connectivity matrix for feedback connections
between areas of shape (num_areas, num_areas). Must be lower triangular and
zero/False on the diagonal.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inter_area_feedback_nonlinearity</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bioplnn.typing.InterAreaParam">InterAreaParam</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="torch.nn.Module">Module</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nonlinearities for feedback connections of
shape (num_areas, num_areas).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inter_area_feedback_spatial_extents</code>
            </td>
            <td>
                  <code><span title="bioplnn.typing.InterAreaParam">InterAreaParam</span>[<span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kernel sizes for feedback convolutions
of shape (num_areas, num_areas).</p>
              </div>
            </td>
            <td>
                  <code>(3, 3)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pool_mode</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pooling mode for area outputs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;max&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area_time_delay</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to introduce a time delay between areas.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_first</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the input tensor has batch dimension as the first dimension.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any of the provided parameters are invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_areas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">area_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">area_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">common_area_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inter_area_feedback_connectivity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">InterAreaParam</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inter_area_feedback_nonlinearity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">InterAreaParam</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inter_area_feedback_spatial_extents</span><span class="p">:</span> <span class="n">InterAreaParam</span><span class="p">[</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">area_time_delay</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pool_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="n">batch_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the SpatiallyEmbeddedRNN.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_areas: Number of `SpatiallyEmbeddedArea` instances in the network.</span>
<span class="sd">        area_configs: Configuration object(s) for the `SpatiallyEmbeddedArea` instances.</span>
<span class="sd">            If provided as a list, must match the number of areas. If a single config</span>
<span class="sd">            is provided, it will be used for all areas with appropriate adjustments.</span>
<span class="sd">        area_kwargs: Additional keyword arguments for each area. If provided as a list,</span>
<span class="sd">            must match the number of areas.</span>
<span class="sd">        common_area_kwargs: Keyword arguments to apply to all areas.</span>
<span class="sd">        inter_area_feedback_connectivity: Connectivity matrix for feedback connections</span>
<span class="sd">            between areas of shape (num_areas, num_areas). Must be lower triangular and</span>
<span class="sd">            zero/False on the diagonal.</span>
<span class="sd">        inter_area_feedback_nonlinearity: Nonlinearities for feedback connections of</span>
<span class="sd">            shape (num_areas, num_areas).</span>
<span class="sd">        inter_area_feedback_spatial_extents: Kernel sizes for feedback convolutions</span>
<span class="sd">            of shape (num_areas, num_areas).</span>
<span class="sd">        pool_mode: Pooling mode for area outputs.</span>
<span class="sd">        area_time_delay: Whether to introduce a time delay between areas.</span>
<span class="sd">        batch_first: Whether the input tensor has batch dimension as the first dimension.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If any of the provided parameters are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1">############################################################</span>
    <span class="c1"># Area configs</span>
    <span class="c1">############################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span> <span class="o">=</span> <span class="n">num_areas</span>

    <span class="k">if</span> <span class="n">area_configs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">area_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;area_configs cannot be provided if area_configs_kwargs &quot;</span>
                <span class="s2">&quot;or common_area_config_kwargs is provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">area_configs</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;area_configs must be of length num_areas.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;area_kwargs or common_area_kwargs must be provided if &quot;</span>
                    <span class="s2">&quot;area_configs is not provided.&quot;</span>
                <span class="p">)</span>
            <span class="n">area_kwargs</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">area_kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;area_kwargs must be of length num_areas.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">common_area_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">common_area_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">area_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SpatiallyEmbeddedAreaConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="n">common_area_kwargs</span><span class="p">,</span>
                <span class="o">**</span><span class="n">area_kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># Validate area configurations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">area_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">!=</span> <span class="n">area_configs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">in_channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The output channels of area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must match the input &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;channels of area </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="c1">############################################################</span>
    <span class="c1"># RNN parameters</span>
    <span class="c1">############################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">area_time_delay</span> <span class="o">=</span> <span class="n">area_time_delay</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pool_mode</span> <span class="o">=</span> <span class="n">pool_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span> <span class="o">=</span> <span class="n">batch_first</span>

    <span class="c1">############################################################</span>
    <span class="c1"># Initialize areas</span>
    <span class="c1">############################################################</span>

    <span class="c1"># Create areas</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">SpatiallyEmbeddedArea</span><span class="p">(</span><span class="n">area_config</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">area_config</span> <span class="ow">in</span> <span class="n">area_configs</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1">############################################################</span>
    <span class="c1"># Initialize feedback connections</span>
    <span class="c1">############################################################</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">inter_area_feedback_connectivity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">area_config</span><span class="o">.</span><span class="n">feedback_channels</span> <span class="k">for</span> <span class="n">area_config</span> <span class="ow">in</span> <span class="n">area_configs</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;inter_area_feedback_connectivity must be provided if and only if &quot;</span>
                <span class="s2">&quot;feedback_channels is provided for at least one area.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">inter_area_feedback_connectivity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The shape of inter_area_feedback_connectivity must be (num_areas, num_areas).&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_nonlinearity</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">inter_area_feedback_nonlinearity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span> <span class="o">=</span> <span class="n">expand_array_2d</span><span class="p">(</span>
            <span class="n">inter_area_feedback_spatial_extents</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Validate inter_area_feedback_connectivity tensor</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The dimensions of inter_area_feedback_connectivity must match the number of areas.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;inter_area_feedback_connectivity must be a non-zero tensor if provided.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create feedback convolutions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_connectivity</span><span class="p">):</span>
            <span class="n">nonzero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nonzero_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;the feedback connection from area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;is not valid because feedback connections must &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;pass information from later areas to earlier &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;areas (i.e. inter_area_feedback_connectivity must &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;be lower triangular and zero on the diagonal).&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;the connection from area </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> is &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;not valid because area </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> does not receive &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;feedback (hint: feedback_channels may not be provided)&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                        <span class="n">in_channels</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
                        <span class="n">out_channels</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">feedback_channels</span><span class="p">,</span>
                        <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                        <span class="p">],</span>
                        <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span>
                                <span class="mi">0</span>
                            <span class="p">]</span>
                            <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_spatial_extents</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span>
                                <span class="mi">1</span>
                            <span class="p">]</span>
                            <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">bias</span><span class="o">=</span><span class="n">area_configs</span><span class="p">[</span>
                            <span class="n">j</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">default_feedback_state_init_fn</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">get_activation</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inter_area_feedback_nonlinearity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_state0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neuron_state0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feedback_state0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.forward" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Performs forward pass of the SpatiallyEmbeddedRNN.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input tensor. Can be either:
- 4D tensor of shape (batch_size, in_channels, height, width)
  representing a single time step. In this case, num_steps must be
  provided.
- 5D tensor of shape (seq_len, batch_size, in_channels, height, width)
  or (batch_size, seq_len, in_channels, height, width) if
  batch_first=True.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_steps</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of time steps. Required if x is 4D.
If x is 5D, this must match the sequence length dimension in x.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_state0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial outputs for each area. Length should match the
number of areas. Each element can be None to use default initialization.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>neuron_state0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial neuron hidden states for each area and neuron type.
Length should match the number of areas, and each inner sequence length
should match the number of neuron types in that area.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>feedback_state0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial feedback inputs for each area. Length should match
the number of areas.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Outputs for each area. Each tensor has shape:
(seq_len, batch_size, out_channels, height, width) or
(batch_size, seq_len, out_channels, height, width) if batch_first=True.</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Hidden states for each area and neuron type.
Same shape pattern as outputs but with neuron_channels.</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="torch.Tensor">Tensor</span>], <span title="list">list</span>[<span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]], <span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Feedback inputs for each area (None if the area doesn't use feedback).</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If input shape is invalid or num_steps is inconsistent with
the input shape.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neuron_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">feedback_state0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
    <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs forward pass of the SpatiallyEmbeddedRNN.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor. Can be either:</span>
<span class="sd">            - 4D tensor of shape (batch_size, in_channels, height, width)</span>
<span class="sd">              representing a single time step. In this case, num_steps must be</span>
<span class="sd">              provided.</span>
<span class="sd">            - 5D tensor of shape (seq_len, batch_size, in_channels, height, width)</span>
<span class="sd">              or (batch_size, seq_len, in_channels, height, width) if</span>
<span class="sd">              batch_first=True.</span>
<span class="sd">        num_steps: Number of time steps. Required if x is 4D.</span>
<span class="sd">            If x is 5D, this must match the sequence length dimension in x.</span>
<span class="sd">        output_state0: Initial outputs for each area. Length should match the</span>
<span class="sd">            number of areas. Each element can be None to use default initialization.</span>
<span class="sd">        neuron_state0: Initial neuron hidden states for each area and neuron type.</span>
<span class="sd">            Length should match the number of areas, and each inner sequence length</span>
<span class="sd">            should match the number of neuron types in that area.</span>
<span class="sd">        feedback_state0: Initial feedback inputs for each area. Length should match</span>
<span class="sd">            the number of areas.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - Outputs for each area. Each tensor has shape:</span>
<span class="sd">          (seq_len, batch_size, out_channels, height, width) or</span>
<span class="sd">          (batch_size, seq_len, out_channels, height, width) if batch_first=True.</span>
<span class="sd">        - Hidden states for each area and neuron type.</span>
<span class="sd">          Same shape pattern as outputs but with neuron_channels.</span>
<span class="sd">        - Feedback inputs for each area (None if the area doesn&#39;t use feedback).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If input shape is invalid or num_steps is inconsistent with</span>
<span class="sd">            the input shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_states</span><span class="p">(</span>
        <span class="n">output_state0</span><span class="p">,</span>
        <span class="n">neuron_state0</span><span class="p">,</span>
        <span class="n">feedback_state0</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">):</span>
            <span class="c1"># Compute area update and output</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">area_in</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_time_delay</span><span class="p">:</span>
                    <span class="n">area_in</span> <span class="o">=</span> <span class="n">output_states</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">area_in</span> <span class="o">=</span> <span class="n">output_states</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">area_in</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                <span class="n">area_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_spatial_size</span><span class="p">(</span>
                    <span class="n">area_in</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">in_size</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>

            <span class="n">output_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">],</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">area_in</span><span class="p">,</span>
                <span class="n">neuron_state</span><span class="o">=</span><span class="n">neuron_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">feedback_state</span><span class="o">=</span><span class="n">feedback_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Apply feedback</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback_convs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">area_i</span><span class="p">,</span> <span class="n">area_j</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
            <span class="n">area_i</span><span class="p">,</span> <span class="n">area_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">area_i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">area_j</span><span class="p">)</span>
            <span class="n">feedback_states</span><span class="p">[</span><span class="n">area_j</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">feedback_states</span><span class="p">[</span><span class="n">area_j</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">(</span>
                <span class="n">output_states</span><span class="p">[</span><span class="n">area_i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">(</span>
        <span class="n">output_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">neuron_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">feedback_states</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_states</span><span class="p">,</span> <span class="n">neuron_states</span><span class="p">,</span> <span class="n">feedback_states</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_feedback_states" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_feedback_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_feedback_states" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the feedback inputs for all areas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate tensors.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of initialized feedback inputs for each area.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_feedback_states</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the feedback inputs for all areas.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization function.</span>
<span class="sd">        device: Device to allocate tensors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of initialized feedback inputs for each area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">area</span><span class="o">.</span><span class="n">init_feedback_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_neuron_states" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_neuron_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_neuron_states" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the hidden states for all areas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate tensors.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list containing the initialized neuron hidden states for each area.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_neuron_states</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the hidden states for all areas.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization function.</span>
<span class="sd">        device: Device to allocate tensors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list containing the initialized neuron hidden states for each area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">area</span><span class="o">.</span><span class="n">init_neuron_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_output_states" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_output_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_output_states" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the outputs for all areas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate tensors.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of initialized outputs for each area.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_output_states</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the outputs for all areas.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        init_fn: Initialization function.</span>
<span class="sd">        device: Device to allocate tensors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of initialized outputs for each area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">area</span><span class="o">.</span><span class="n">init_output_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_states" class="doc doc-heading">
            <code class=" language-python"><span class="n">init_states</span><span class="p">(</span><span class="n">out0</span><span class="p">,</span> <span class="n">h_neuron0</span><span class="p">,</span> <span class="n">fb0</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">out_init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fb_init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.init_states" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the state of the network.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>out0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial outputs for each area. If None, default initialization is used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>h_neuron0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial neuron hidden states for each area. If None, default
initialization is used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fb0</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial feedback inputs for each area. If None, default initialization is used.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_steps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of time steps.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function for outputs if out0 is None. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function for hidden states if h_neuron0 is None.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fb_init_fn</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bioplnn.typing.TensorInitFnType">TensorInitFnType</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialization function for feedback inputs if fb0 is None.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="torch.device">device</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to allocate tensors on. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Initialized outputs for each area and time step</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, <span title="int">int</span>, None]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Initialized neuron hidden states for each area, time step, and neuron type</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]], <span title="list">list</span>[<span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, None]]]], <span title="list">list</span>[<span title="list">list</span>[<span title="typing.Union">Union</span>[<span title="torch.Tensor">Tensor</span>, <span title="int">int</span>, None]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Initialized feedback inputs for each area and time step</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the length of out0, h_neuron0, or fb0 doesn't match
the number of areas.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_states</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">out0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
    <span class="n">h_neuron0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]],</span>
    <span class="n">fb0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">out_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fb_init_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorInitFnType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
    <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]],</span>
    <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the state of the network.</span>

<span class="sd">    Args:</span>
<span class="sd">        out0: Initial outputs for each area. If None, default initialization is used.</span>
<span class="sd">        h_neuron0: Initial neuron hidden states for each area. If None, default</span>
<span class="sd">            initialization is used.</span>
<span class="sd">        fb0: Initial feedback inputs for each area. If None, default initialization is used.</span>
<span class="sd">        num_steps: Number of time steps.</span>
<span class="sd">        batch_size: Batch size.</span>
<span class="sd">        out_init_fn: Initialization function for outputs if out0 is None. Defaults to None.</span>
<span class="sd">        hidden_init_fn: Initialization function for hidden states if h_neuron0 is None.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        fb_init_fn: Initialization function for feedback inputs if fb0 is None.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        device: Device to allocate tensors on. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - Initialized outputs for each area and time step</span>
<span class="sd">        - Initialized neuron hidden states for each area, time step, and neuron type</span>
<span class="sd">        - Initialized feedback inputs for each area and time step</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the length of out0, h_neuron0, or fb0 doesn&#39;t match</span>
<span class="sd">            the number of areas.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Validate input shapes of out0, h_neuron0, fb0</span>
    <span class="k">if</span> <span class="n">out0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out0</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">out0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The length of out0 must be equal to the number of areas.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">h_neuron0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_neuron0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_neuron0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The length of h_neuron0 must be equal to the number of areas.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">fb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fb0</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fb0</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The length of fb0 must be equal to the number of areas.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Initialize default values</span>
    <span class="n">h_neuron0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_neuron_states</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_init_fn</span><span class="p">,</span> <span class="n">device</span>
    <span class="p">)</span>
    <span class="n">fb0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_feedback_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">fb_init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">out0_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_output_states</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">out_init_fn</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># Initialize output, hidden state, and feedback lists</span>
    <span class="n">outs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_steps</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">h_neurons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">fbs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">use_feedback</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_steps</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Fill time step -1 with the initial values</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_areas</span><span class="p">):</span>
        <span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">out0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out0_default</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fbs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">fb0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fb0_default</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">num_neuron_types</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">h_neurons</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">h_neuron0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">h_neuron0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">h_neuron0_default</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="n">h_neurons</span><span class="p">,</span> <span class="n">fbs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.query_neuron_states" class="doc doc-heading">
            <code class=" language-python"><span class="n">query_neuron_states</span><span class="p">(</span><span class="n">neuron_states</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">neuron_type</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neuron_subtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_location_i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_location_j</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#src.bioplnn.models.spatially_embedded.SpatiallyEmbeddedRNN.query_neuron_states" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Query the model states for a given area, time step, neuron type, neuron subtype, and spatial location.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>neuron_states</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="torch.Tensor">Tensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of lists of tensors containing the model states.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>area</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The area index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>neuron_type</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The neuron type index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_step</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time step index. If not provided, all time steps are returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The batch index. If not provided, all batches are returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>neuron_subtype</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The neuron subtype index. If not provided, all neuron subtypes are returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_location_i</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The spatial location (height). If not provided, all spatial locations are returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_location_j</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The spatial location (width). If not provided, all spatial locations are returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The queried state of shape (batch_size_slice, channels, height, width)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/bioplnn/models/spatially_embedded.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_neuron_states</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">neuron_states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
    <span class="n">area</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">neuron_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">time_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">neuron_subtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_location_i</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_location_j</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query the model states for a given area, time step, neuron type, neuron subtype, and spatial location.</span>

<span class="sd">    Args:</span>
<span class="sd">        neuron_states: List of lists of tensors containing the model states.</span>
<span class="sd">        area: The area index.</span>
<span class="sd">        neuron_type: The neuron type index.</span>
<span class="sd">        time_step: The time step index. If not provided, all time steps are returned.</span>
<span class="sd">        batch: The batch index. If not provided, all batches are returned.</span>
<span class="sd">        neuron_subtype: The neuron subtype index. If not provided, all neuron subtypes are returned.</span>
<span class="sd">        spatial_location_i: The spatial location (height). If not provided, all spatial locations are returned.</span>
<span class="sd">        spatial_location_j: The spatial location (width). If not provided, all spatial locations are returned.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The queried state of shape (batch_size_slice, channels, height, width)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_idx</span> <span class="o">=</span> <span class="n">time_step</span>
    <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="k">if</span> <span class="n">neuron_subtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neuron_subtype_idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">neuron_subtype_idx</span> <span class="o">=</span> <span class="n">neuron_subtype</span>
    <span class="k">if</span> <span class="n">spatial_location_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_location_idx_i</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spatial_location_idx_i</span> <span class="o">=</span> <span class="n">spatial_location_i</span>
    <span class="k">if</span> <span class="n">spatial_location_j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_location_idx_j</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spatial_location_idx_j</span> <span class="o">=</span> <span class="n">spatial_location_j</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">area</span><span class="p">][</span><span class="n">neuron_type</span><span class="p">][</span>
            <span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">time_idx</span><span class="p">,</span>
            <span class="n">neuron_subtype_idx</span><span class="p">,</span>
            <span class="n">spatial_location_idx_i</span><span class="p">,</span>
            <span class="n">spatial_location_idx_j</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neuron_states</span><span class="p">[</span><span class="n">area</span><span class="p">][</span><span class="n">neuron_type</span><span class="p">][</span>
            <span class="n">time_idx</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">neuron_subtype_idx</span><span class="p">,</span>
            <span class="n">spatial_location_idx_i</span><span class="p">,</span>
            <span class="n">spatial_location_idx_j</span><span class="p">,</span>
        <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/FieteLab/torch-biopl-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.expand"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>